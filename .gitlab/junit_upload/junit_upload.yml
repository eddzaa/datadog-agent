---
unit_tests_arm64_windows_junit_upload:
  stage: junit_upload
  rules:
    - !reference [.except_mergequeue]
    - when: always
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64$DATADOG_AGENT_BUILDIMAGES_SUFFIX:$DATADOG_AGENT_BUILDIMAGES
  tags: ["arch:amd64"]
  needs:
    - tests_deb-arm64-py3
    - tests_rpm-arm64-py3
    - tests_windows-x64
    - tests_windows-x64-fast-v2
  script:
    - source /root/.bashrc
    # Upload generated junit files
    - set +x
    - export DATADOG_API_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.datadog_api_key_org2 --with-decryption --query "Parameter.Value" --out text)
    - set -x
    - for f in junit-*.tgz; do inv -e junit-upload --tgz-path $f; done

system_probe_arm64_junit_upload:
  stage: junit_upload
  rules:
    - !reference [.except_mergequeue]
    - when: always
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64$DATADOG_AGENT_BUILDIMAGES_SUFFIX:$DATADOG_AGENT_BUILDIMAGES
  tags: ["arch:amd64"]
  allow_failure: true
  needs:
    - job: kernel_matrix_testing_run_tests_arm64
      parallel:
        matrix:
          - TAG:
              [
                "ubuntu_18.04",
                "ubuntu_20.04",
                "ubuntu_22.04",
                "ubuntu_23.10",
                "amzn_4.14",
                "amzn_5.4",
                "amzn_5.10",
                "fedora_37",
                "fedora_38",
                "debian_10",
                "debian_11",
                "debian_12",
                "centos_79",
                "centos_8",
              ]
            TEST_SET: ["no_tracersuite", "only_tracersuite"]
      optional: true
  script:
    - source /root/.bashrc
    # Upload generated junit files
    - set +x
    - export DATADOG_API_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.datadog_api_key_org2 --with-decryption --query "Parameter.Value" --out text)
    - set -x
    - ss=0; for f in $DD_AGENT_TESTING_DIR/junit-*.tar.gz; do [[ -e "$f" ]] || continue; inv -e junit-upload --tgz-path $f || ((ss++)); done; exit $ss
